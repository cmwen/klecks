# AGENTS.md - Klecks Project Documentation

## Project Overview

Klecks is an open-source painting application for the browser, created by [bitbof](https://bitbof.com). It can run in standalone mode or as an embeddable component for drawing communities.

## Project Structure

### Root Directory
- `src/` - Source code
- `dist/` - Build output (generated)
- `examples/` - Example usage (especially for embed mode)
- `Dockerfile` - Docker configuration for containerized deployment
- `docker-compose.yml` - Docker compose configuration
- `package.json` - NPM dependencies and scripts

### Source Code Structure (`src/`)

#### Entry Points
- `src/index.html` - Main entry point for standalone mode
- `src/embed.ts` - Entry point for embed mode
- `src/help.html` - Help page entry point

#### Application Code (`src/app/`)

##### Main Application (`src/app/script/`)
- `main-standalone.ts` - Standalone mode initialization
- `main-embed.ts` - Embed mode initialization

##### Core Components (`src/app/script/app/`)
- `kl-app.ts` - Main application class
- `kl-app-import-handler.ts` - Handles importing files
- `kl-app-select.ts` - Selection tool logic
- `console-api.ts` - Console API for debugging

##### Klecks Core (`src/app/script/klecks/`)
- `kl-types.ts` - TypeScript type definitions
- `kl-config.ts` - Configuration settings
- `brushes/` - Brush implementations (pen, blend, sketchy, pixel, chemy, smudge, eraser)
- `brushes-ui/` - Brush user interface components
- `canvas/` - Canvas manipulation utilities
- `events/` - Event handling
- `filters/` - Image filters (blur, tilt-shift, curves, distort, noise)
- `history/` - Undo/redo functionality
- `image-operations/` - Image manipulation operations
- `select-tool/` - Selection tool implementation
- `storage/` - File I/O and storage management (PSD import/export, IndexedDB)
- `ui/` - User interface components
  - `components/` - Reusable UI components
  - `easel/` - Drawing canvas area and tools
  - `mobile/` - Mobile-specific UI
  - `modals/` - Modal dialogs
  - `project-viewport/` - Canvas viewport
  - `tool-tabs/` - Tool panels and tabs
- `utils/` - Utility functions

##### BB Library (`src/app/script/bb/`)
BitBof's utility library:
- `bb.ts` - Main export file
- `base/` - Base utilities (canvas, browser detection, DOM helpers)
- `color/` - Color manipulation (RGB, HSV, CMYK)
- `input/` - Input handling (pointer, keyboard, touch gestures)
- `math/` - Mathematical utilities (vectors, matrices, geometry)
- `transform/` - Transformation utilities
- `multi-polygon/` - Polygon operations

##### FX Canvas (`src/app/script/fx-canvas/`)
WebGL-powered filter system:
- `core/` - Core WebGL functionality
- `filters/` - Filter implementations
- `shaders/` - GLSL shader code
- `math/` - Math utilities for filters

##### Embed System (`src/app/script/embed/`)
- `bootstrap/` - Embed initialization and wrapper

##### Other
- `language/` - Internationalization system
- `theme/` - Theme management
- `polyfills/` - Browser compatibility polyfills

#### Languages (`src/languages/`)
- `_base-en.json5` - Base English language file (source of truth)
- `{code}.json5` - Language files (de, es, fi, fr, hu, id, ja, jv, ko, lv, nl, pt-BR, ru, su, sv, zh-CN, zh-TW)
- `generate.js` - Language file generation script
- `languages.json` - ISO 639-1 language codes

#### Generated Language Files (`src/app/languages/`)
Generated by `npm run lang:build` from `src/languages/`:
- JSON and TypeScript files for each language

#### Static Assets
- `src/app/img/` - Images and icons
- `src/app/fonts/` - Custom fonts
- `src/app/style/` - SCSS stylesheets

## Build System

The project uses [Parcel](https://parceljs.org/) as its bundler.

### Build Commands

```bash
# Initialize project
npm ci

# Generate language files (required before build)
npm run lang:build

# Development server
npm run start

# Production builds
npm run build              # Standalone version → dist/
npm run build:embed        # Embed version → dist/
npm run build:help         # Help page → dist/

# Language management
npm run lang:add <code>    # Create new translation file
npm run lang:sync <code>   # Sync translation file (TODO)
npm run lang:build         # Generate language files
npm run lang:build -- --missing  # List missing translations
```

### Build Output
All builds output to the `dist/` directory.

## Technologies Used

### Core Dependencies
- **ag-psd** - PSD file import/export
- **Parcel** - Build system and bundler
- **TypeScript** - Primary language
- **SCSS** - Styling
- **WebGL/GLSL** - GPU-accelerated filters

### Key Libraries
- **glfx.js** - WebGL filters
- **FileSaver.js** - File saving functionality
- **polygon-clipping** - Polygon operations
- **transformation-matrix** - Matrix transformations
- **json5** - JSON5 parsing for language files
- **js-beautify** - Code formatting

### Browser APIs
- **Canvas 2D** - Main drawing surface
- **IndexedDB** - Local storage for recovery
- **Pointer Events** - Input handling
- **File API** - File import/export

## Key Features

### Drawing Features
- **Layers** - Multiple layer support with blend modes
- **Brushes** - Pen, blend, sketchy, pixel, chemy, smudge, eraser
- **Tools** - Selection, paint bucket, text, shapes, gradient
- **Pressure Support** - Pen pressure sensitivity
- **Stabilizer** - Line smoothing for cleaner strokes
- **Touch Gestures** - Multi-touch support for tablets/phones

### Image Processing
- **WebGL Filters** - Blur, tilt-shift, curves, distort, noise
- **Lineart Extraction** - Extract line art from images
- **Transform** - Rotate, scale, perspective transform
- **Crop/Expand** - Canvas size adjustment
- **Resize** - Image resizing with quality options

### User Experience
- **Multi-language** - 10+ languages supported
- **Responsive** - Works on desktop, tablet, and phone
- **Recovery System** - Auto-save with recovery on crash
- **Keyboard Shortcuts** - Extensive keyboard support
- **Undo/Redo** - Full history management

## Development Workflow

### Setting Up Development Environment

1. Clone the repository
2. Install Node.js (version compatible with package.json)
3. Run `npm ci` to install dependencies
4. Run `npm run lang:build` to generate language files
5. Run `npm run start` to start development server
6. Open http://localhost:1234 in browser

### Making Changes

1. Edit source files in `src/`
2. Changes hot-reload in development mode
3. Run `npm run build` to test production build
4. Test in multiple browsers if changing browser-specific code

### Adding Translations

1. Run `npm run lang:add <code>` to create new language file
2. Edit `src/languages/<code>.json5`
3. Fill in `value` fields with translations
4. Run `npm run lang:build` to generate TypeScript files
5. Test in the application

### Docker Development

```bash
# Build Docker image
docker-compose build

# Run container
docker-compose up -d

# Access at http://localhost:5050
```

## Architecture Patterns

### Main Application Flow
1. `index.html` loads → `main-standalone.ts`
2. Language files initialized
3. IndexedDB connection established
4. Recovery check for unsaved work
5. `KlApp` instantiated with project
6. UI components mounted

### Embed Flow
1. `embed.ts` loads → `EmbedWrapper` 
2. Minimal initial bundle for fast feedback
3. Main bundle loads → `Embed` class
4. Project/PSD loaded
5. `KlApp` instantiated in embed mode

### Event System
- Pointer events normalized across devices
- Event chain pattern for gesture recognition
- Canvas coordinates transformed through viewport

### History System
- Command pattern for undo/redo
- Snapshots stored for canvas state
- Efficient memory management with canvas pooling

## Testing and Quality

### Manual Testing Checklist
- Test all brushes with various settings
- Test all filters with different parameters
- Test layer operations (add, delete, reorder, blend modes)
- Test file import/export (PNG, PSD)
- Test on different screen sizes
- Test keyboard shortcuts
- Test touch gestures on tablet/phone
- Test recovery system
- Test in different browsers

### Browser Compatibility
- Chrome 61+
- Firefox 60+
- Safari iOS 9+
- Firefox ESR
- Modern browsers (>0.2% usage)

## Deployment

### Standalone Deployment
1. Build with `npm run build` and `npm run build:help`
2. Serve `dist/` directory as static files
3. Configure web server for SPA routing (optional)

### Docker Deployment
Use provided Dockerfile and docker-compose.yml for containerized deployment.

### GitHub Pages Deployment
The application can be deployed to GitHub Pages by:
1. Building the application
2. Pushing `dist/` contents to `gh-pages` branch
3. Configuring repository settings for GitHub Pages

## Contributing

### Code Style
- Follow existing TypeScript patterns
- Use meaningful variable names
- Add comments for complex logic
- Keep functions focused and small

### Pull Request Process
1. Create feature branch
2. Make focused changes
3. Test thoroughly
4. Update documentation if needed
5. Submit PR with clear description

## License

MIT License - See LICENSE file for details.

Copyright © 2025 bitbof

## Additional Resources

- **Demo**: https://kleki.com/
- **About**: https://kleki.com/about/
- **Blog**: https://blog.kleki.com/
- **Donate**: https://kleki.com/donate/
- **Repository**: https://github.com/cmwen/klecks

## Credits

- Created by [bitbof](https://bitbof.com)
- **glfx.js** - WebGL filters by Evan Wallace
- **Harmony** - Inspiration for Sketchy brush
- **FileSaver.js** - File saving by Eli Grey
- **ag-psd** - PSD support by Agamnentzar
- **MDN Polyfills** - Browser compatibility
- **Gonkees-Shaders** - GLSL shaders by Gonkee
